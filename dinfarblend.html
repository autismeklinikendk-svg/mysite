<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dinfar Blend Calc</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
:root {
  --accent: #c41e3a;
  --glass: rgba(0,0,0,0.65);
  --border: rgba(255,255,255,0.08);
  --powder-color: #8B0000;
  --solvent-color: #006400;
  --carrier-color: #00008B;
}

* { box-sizing: border-box; font-family: Inter, system-ui, -apple-system, sans-serif; }

body {
  margin: 0;
  min-height: 100vh;
  background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url("https://images7.alphacoders.com/398/398372.jpg") center / cover no-repeat fixed;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
}

.panel { width: 100%; max-width: 1200px; background: var(--glass); backdrop-filter: blur(14px); border: 1px solid var(--border); border-radius: 20px; padding: 30px; box-shadow: 0 40px 90px rgba(0,0,0,0.7); display: flex; flex-direction: column; }

h1 { margin: 0 0 6px; font-size: 32px; letter-spacing: 0.6px; text-align: center; }
.subtitle { opacity: 0.7; margin-bottom: 26px; text-align: center; }

.links { margin-bottom: 30px; display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
.links a { padding: 12px 24px; background: rgba(196,30,58,0.2); border: 1px solid var(--accent); border-radius: 12px; color: #fff; text-decoration: none; font-weight: 600; transition: background 0.3s; }
.links a:hover { background: rgba(196,30,58,0.4); }
.links a.active { background: rgba(196,30,58,0.5); border-color: #fff; cursor: default; }

.content { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; flex: 1; }
.inputs { display: flex; flex-direction: column; gap: 18px; }
.field { display: flex; flex-direction: column; }
.field label { font-size: 13px; opacity: 0.8; margin-bottom: 8px; }
.field input, .field select { width: 100%; padding: 18px 16px; border-radius: 14px; border: 1px solid var(--border); background: rgba(0,0,0,0.55); color: #fff; font-size: 18px; font-weight: 500; }
.field input:focus, .field select:focus { outline: none; border-color: var(--accent); }

.checkbox-field { display: flex; align-items: center; gap: 10px; font-size: 16px; margin: 10px 0; }

.outputs { display: flex; flex-direction: column; gap: 30px; }
.results { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
.result { background: rgba(0,0,0,0.5); border: 1px solid var(--border); border-radius: 14px; padding: 20px; text-align: center; display: flex; flex-direction: column; justify-content: center; }
.result span { display: block; font-size: 13px; opacity: 0.7; margin-bottom: 8px; }
.result strong { font-size: 28px; color: var(--accent); }

.result.powder strong { color: var(--powder-color); }
.result.solvent strong { color: var(--solvent-color); }
.result.carrier strong { color: var(--carrier-color); }

.final-yield { grid-column: 1 / -1; background: rgba(196,30,58,0.2); border: 2px solid var(--accent); padding: 30px; font-size: 32px; }

.chart-container { position: relative; height: 380px; background: rgba(0,0,0,0.5); border: 1px solid var(--border); border-radius: 14px; padding: 20px; }

.actions { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
.actions button { padding: 14px 28px; background: rgba(196,30,58,0.2); border: 1px solid var(--accent); border-radius: 12px; color: #fff; font-weight: 600; cursor: pointer; transition: background 0.3s; }
.actions button:hover { background: rgba(196,30,58,0.4); }

.footer { margin-top: 30px; font-size: 11px; opacity: 0.5; text-align: right; }

@media (max-width: 900px) {
  .content { grid-template-columns: 1fr; }
  .results { grid-template-columns: 1fr; }
}

.hidden { display: none !important; }
</style>
</head>
<body>

<div class="panel" id="captureArea">
  <h1>Dinfar Blend Calc</h1>
  <div class="subtitle">Blend steroid solution calculator (up to 3 compounds)</div>

  <div class="links">
    <a href="index.html">Single Compound</a>
    <a href="dinfarblend.html" class="active">Blend Calculator</a>
  </div>

  <div class="content">
    <div class="inputs">
      <div class="field">
        <label>Desired Final Volume (ml)</label>
        <input id="totalVol" type="number" value="10" oninput="calc()">
      </div>

      <div class="field">
        <label>Sterile Filter Pore Size</label>
        <select id="filter" onchange="calc()">
          <option value="none">No Filter Loss Compensation</option>
          <option value="0.45">0.45µm (~0.8–1.2ml loss)</option>
          <option value="0.22">0.22µm (~1.2–2.0ml loss)</option>
          <option value="double">Double Filtration (0.45 + 0.22µm) (~2.0–3.0ml loss)</option>
          <option value="custom">Custom Loss (ml)</option>
        </select>
      </div>

      <div class="field" id="customLossField" style="display:none;">
        <label>Custom Filter Loss (ml)</label>
        <input id="customLoss" type="number" step="0.1" value="1.5" oninput="calc()">
      </div>

      <!-- Compound 1 (always visible) -->
      <div class="field">
        <label>Compound 1</label>
        <select id="compound1" onchange="updateDisplacement(1); calc()">
          <option value="custom">Custom (manual displacement)</option>
          <option value="test-base">Testosterone Base</option>
          <option value="test-p">Testosterone Propionate</option>
          <option value="test-phenyl">Testosterone Phenylpropionate</option>
          <option value="test-c">Testosterone Cypionate</option>
          <option value="test-e">Testosterone Enanthate</option>
          <option value="test-iso">Testosterone Isocaproate</option>
          <option value="test-deca">Testosterone Decanoate</option>
          <option value="test-undecanoate">Testosterone Undecanoate</option>
          <option value="test-susp">Testosterone Suspension (water-based)</option>
          <option value="tren-a">Trenbolone Acetate</option>
          <option value="tren-e">Trenbolone Enanthate</option>
          <option value="tren-hex">Trenbolone Hexahydrobenzylcarbonate</option>
          <option value="nandrolone-base">Nandrolone Base</option>
          <option value="deca">Nandrolone Decanoate (Deca)</option>
          <option value="npp">Nandrolone Phenylpropionate (NPP)</option>
          <option value="eq">Boldenone Undecylenate (EQ)</option>
          <option value="bold-cyp">Boldenone Cypionate</option>
          <option value="masteron-p">Drostanolone Propionate (Masteron P)</option>
          <option value="masteron-e">Drostanolone Enanthate (Masteron E)</option>
          <option value="primo-e">Methenolone Enanthate (Primobolan)</option>
          <option value="trestolone">Trestolone (MENT)</option>
          <option value="trestolone-a">Trestolone Acetate</option>
          <option value="dhb">1-Testosterone Cypionate (DHB)</option>
          <option value="winstrol">Winstrol (Stanozolol) - Injectable</option>
          <option value="dbol">Dianabol (Methandrostenolone) - Injectable</option>
          <option value="anadrol">Anadrol (Oxymetholone) - Injectable</option>
          <option value="anavar">Anavar (Oxandrolone) - Injectable</option>
          <option value="tbol">Turinabol (Chlorodehydromethyltestosterone) - Injectable</option>
          <option value="sdrol">Superdrol (Methasterone) - Injectable</option>
          <option value="proviron">Proviron (Mesterolone) - Injectable</option>
          <option value="yk11">YK-11 - Injectable</option>
        </select>
      </div>

      <div class="field">
        <label>Compound 1 Conc (mg/ml)</label>
        <input id="mgml1" type="number" value="150" oninput="calc()">
      </div>

      <div class="field">
        <label>Compound 1 Displacement (ml/g)</label>
        <input id="disp1" type="number" step="0.001" value="0.909" oninput="calc()">
      </div>

      <div class="field">
        <label>Compound 1 Purity (%)</label>
        <input id="purity1" type="number" value="100" oninput="calc()">
      </div>

      <!-- Checkbox for Compound 2 -->
      <div class="checkbox-field">
        <input type="checkbox" id="enableCompound2" onchange="toggleCompound(2); calc()">
        <label for="enableCompound2">Add Compound 2</label>
      </div>

      <div id="compound2Group" class="hidden">
        <div class="field">
          <label>Compound 2</label>
          <select id="compound2" onchange="updateDisplacement(2); calc()">
            <option value="custom">Custom (manual displacement)</option>
            <!-- same full list -->
            <option value="test-base">Testosterone Base</option>
            <option value="test-p">Testosterone Propionate</option>
            <option value="test-phenyl">Testosterone Phenylpropionate</option>
            <option value="test-c">Testosterone Cypionate</option>
            <option value="test-e">Testosterone Enanthate</option>
            <option value="test-iso">Testosterone Isocaproate</option>
            <option value="test-deca">Testosterone Decanoate</option>
            <option value="test-undecanoate">Testosterone Undecanoate</option>
            <option value="test-susp">Testosterone Suspension (water-based)</option>
            <option value="tren-a">Trenbolone Acetate</option>
            <option value="tren-e">Trenbolone Enanthate</option>
            <option value="tren-hex">Trenbolone Hexahydrobenzylcarbonate</option>
            <option value="nandrolone-base">Nandrolone Base</option>
            <option value="deca">Nandrolone Decanoate (Deca)</option>
            <option value="npp">Nandrolone Phenylpropionate (NPP)</option>
            <option value="eq">Boldenone Undecylenate (EQ)</option>
            <option value="bold-cyp">Boldenone Cypionate</option>
            <option value="masteron-p">Drostanolone Propionate (Masteron P)</option>
            <option value="masteron-e">Drostanolone Enanthate (Masteron E)</option>
            <option value="primo-e">Methenolone Enanthate (Primobolan)</option>
            <option value="trestolone">Trestolone (MENT)</option>
            <option value="trestolone-a">Trestolone Acetate</option>
            <option value="dhb">1-Testosterone Cypionate (DHB)</option>
            <option value="winstrol">Winstrol (Stanozolol) - Injectable</option>
            <option value="dbol">Dianabol (Methandrostenolone) - Injectable</option>
            <option value="anadrol">Anadrol (Oxymetholone) - Injectable</option>
            <option value="anavar">Anavar (Oxandrolone) - Injectable</option>
            <option value="tbol">Turinabol (Chlorodehydromethyltestosterone) - Injectable</option>
            <option value="sdrol">Superdrol (Methasterone) - Injectable</option>
            <option value="proviron">Proviron (Mesterolone) - Injectable</option>
            <option value="yk11">YK-11 - Injectable</option>
          </select>
        </div>

        <div class="field">
          <label>Compound 2 Conc (mg/ml)</label>
          <input id="mgml2" type="number" value="150" oninput="calc()">
        </div>

        <div class="field">
          <label>Compound 2 Displacement (ml/g)</label>
          <input id="disp2" type="number" step="0.001" value="0.909" oninput="calc()">
        </div>

        <div class="field">
          <label>Compound 2 Purity (%)</label>
          <input id="purity2" type="number" value="100" oninput="calc()">
        </div>
      </div>

      <!-- Checkbox for Compound 3 -->
      <div class="checkbox-field">
        <input type="checkbox" id="enableCompound3" onchange="toggleCompound(3); calc()">
        <label for="enableCompound3">Add Compound 3</label>
      </div>

      <div id="compound3Group" class="hidden">
        <div class="field">
          <label>Compound 3</label>
          <select id="compound3" onchange="updateDisplacement(3); calc()">
            <option value="custom">Custom (manual displacement)</option>
            <!-- same full list -->
            <option value="test-base">Testosterone Base</option>
            <option value="test-p">Testosterone Propionate</option>
            <option value="test-phenyl">Testosterone Phenylpropionate</option>
            <option value="test-c">Testosterone Cypionate</option>
            <option value="test-e">Testosterone Enanthate</option>
            <option value="test-iso">Testosterone Isocaproate</option>
            <option value="test-deca">Testosterone Decanoate</option>
            <option value="test-undecanoate">Testosterone Undecanoate</option>
            <option value="test-susp">Testosterone Suspension (water-based)</option>
            <option value="tren-a">Trenbolone Acetate</option>
            <option value="tren-e">Trenbolone Enanthate</option>
            <option value="tren-hex">Trenbolone Hexahydrobenzylcarbonate</option>
            <option value="nandrolone-base">Nandrolone Base</option>
            <option value="deca">Nandrolone Decanoate (Deca)</option>
            <option value="npp">Nandrolone Phenylpropionate (NPP)</option>
            <option value="eq">Boldenone Undecylenate (EQ)</option>
            <option value="bold-cyp">Boldenone Cypionate</option>
            <option value="masteron-p">Drostanolone Propionate (Masteron P)</option>
            <option value="masteron-e">Drostanolone Enanthate (Masteron E)</option>
            <option value="primo-e">Methenolone Enanthate (Primobolan)</option>
            <option value="trestolone">Trestolone (MENT)</option>
            <option value="trestolone-a">Trestolone Acetate</option>
            <option value="dhb">1-Testosterone Cypionate (DHB)</option>
            <option value="winstrol">Winstrol (Stanozolol) - Injectable</option>
            <option value="dbol">Dianabol (Methandrostenolone) - Injectable</option>
            <option value="anadrol">Anadrol (Oxymetholone) - Injectable</option>
            <option value="anavar">Anavar (Oxandrolone) - Injectable</option>
            <option value="tbol">Turinabol (Chlorodehydromethyltestosterone) - Injectable</option>
            <option value="sdrol">Superdrol (Methasterone) - Injectable</option>
            <option value="proviron">Proviron (Mesterolone) - Injectable</option>
            <option value="yk11">YK-11 - Injectable</option>
          </select>
        </div>

        <div class="field">
          <label>Compound 3 Conc (mg/ml)</label>
          <input id="mgml3" type="number" value="0" oninput="calc()">
        </div>

        <div class="field">
          <label>Compound 3 Displacement (ml/g)</label>
          <input id="disp3" type="number" step="0.001" value="0.909" oninput="calc()">
        </div>

        <div class="field">
          <label>Compound 3 Purity (%)</label>
          <input id="purity3" type="number" value="100" oninput="calc()">
        </div>
      </div>

      <div class="field">
        <label>Benzyl Alcohol (BA) %</label>
        <input id="baPct" type="number" value="2" oninput="calc()">
      </div>

      <div class="field">
        <label>Benzyl Benzoate (BB) %</label>
        <input id="bbPct" type="number" value="15" oninput="calc()">
      </div>

      <!-- Extra Solvent Checkbox -->
      <div class="checkbox-field">
        <input type="checkbox" id="enableExtraSolvent" onchange="toggleExtraSolvent(); calc()">
        <label for="enableExtraSolvent">Add Extra Solvent (Guaiacol, PEG, etc.)</label>
      </div>

      <div id="extraSolventGroup" class="hidden">
        <div class="field">
          <label>Extra Solvent %</label>
          <input id="extraSolventPct" type="number" value="0" oninput="calc()">
        </div>
        <div class="field">
          <label>Extra Solvent Type</label>
          <select id="extraSolventType" onchange="calc()">
            <option value="none">None</option>
            <option value="guaiacol">Guaiacol (1.129 g/ml)</option>
            <option value="peg400">PEG 400 (1.128 g/ml)</option>
            <option value="dmso">DMSO (1.10 g/ml)</option>
            <option value="ethyl-lactate">Ethyl L-Lactate (1.035 g/ml)</option>
            <option value="custom">Custom (manual density)</option>
          </select>
        </div>
        <div class="field" id="customExtraSolventDensityField" style="display:none;">
          <label>Custom Extra Solvent Density (g/ml)</label>
          <input id="customExtraSolventDensity" type="number" step="0.001" value="1.1" oninput="calc()">
        </div>
      </div>

      <!-- Main Carrier -->
      <div class="field">
        <label>Main Carrier Oil</label>
        <select id="mainCarrier" onchange="calc()">
          <option value="gso">Grapeseed Oil (GSO) (~0.92 g/ml)</option>
          <option value="mct">MCT Oil (~0.95 g/ml)</option>
          <option value="castor">Castor Oil (~0.96 g/ml)</option>
          <option value="sesame">Sesame Oil (~0.92 g/ml)</option>
          <option value="mig840">Miglyol 840 (~0.94 g/ml)</option>
          <option value="mig812">Miglyol 812N (0.95 g/ml)</option>
          <option value="eo">Ethyl Oleate (EO) (0.87 g/ml)</option>
          <option value="custom">Custom (manual density)</option>
        </select>
      </div>

      <div class="field" id="customMainCarrierField" style="display:none;">
        <label>Custom Main Carrier Density (g/ml)</label>
        <input id="customMainCarrierDensity" type="number" step="0.001" value="0.92" oninput="calc()">
      </div>

      <!-- Second Carrier Checkbox -->
      <div class="checkbox-field">
        <input type="checkbox" id="enableSecondCarrier" onchange="toggleSecondCarrier(); calc()">
        <label for="enableSecondCarrier">Mix with Second Carrier Oil</label>
      </div>

      <div id="secondCarrierGroup" class="hidden">
        <div class="field">
          <label>Carrier Mix % (second oil)</label>
          <input id="carrierMixPct" type="number" value="0" min="0" max="100" oninput="calc()">
        </div>
        <div class="field">
          <label>Second Carrier Oil</label>
          <select id="secondCarrier" onchange="calc()">
            <option value="none">None</option>
            <option value="castor">Castor Oil (~0.96 g/ml)</option>
            <option value="gso">Grapeseed Oil (GSO) (~0.92 g/ml)</option>
            <option value="mct">MCT Oil (~0.95 g/ml)</option>
            <option value="sesame">Sesame Oil (~0.92 g/ml)</option>
            <option value="mig840">Miglyol 840 (~0.94 g/ml)</option>
            <option value="mig812">Miglyol 812N (0.95 g/ml)</option>
            <option value="eo">Ethyl Oleate (EO) (0.87 g/ml)</option>
            <option value="custom">Custom (manual density)</option>
          </select>
        </div>
        <div class="field" id="customSecondCarrierField" style="display:none;">
          <label>Custom Second Carrier Density (g/ml)</label>
          <input id="customSecondCarrierDensity" type="number" step="0.001" value="0.96" oninput="calc()">
        </div>
      </div>
    </div>

    <div class="outputs">
      <div class="results">
        <!-- Left: What you add -->
        <div class="result powder">
          <span>Compound 1 Powder</span>
          <strong id="powder1">0 g</strong>
        </div>
        <div class="result powder hidden" id="powder2Result">
          <span>Compound 2 Powder</span>
          <strong id="powder2">0 g</strong>
        </div>
        <div class="result powder hidden" id="powder3Result">
          <span>Compound 3 Powder</span>
          <strong id="powder3">0 g</strong>
        </div>

        <div class="result solvent">
          <span>BA Volume</span>
          <strong id="baVol">0 ml</strong>
        </div>
        <div class="result solvent">
          <span>BA Weight</span>
          <strong id="baWeight">0 g</strong>
        </div>
        <div class="result solvent">
          <span>BB Volume</span>
          <strong id="bbVol">0 ml</strong>
        </div>
        <div class="result solvent">
          <span>BB Weight</span>
          <strong id="bbWeight">0 g</strong>
        </div>

        <div class="result solvent hidden" id="extraSolventVolResult">
          <span>Extra Solvent Volume</span>
          <strong id="extraSolventVol">0 ml</strong>
        </div>
        <div class="result solvent hidden" id="extraSolventWeightResult">
          <span>Extra Solvent Weight</span>
          <strong id="extraSolventWeight">0 g</strong>
        </div>

        <div class="result carrier">
          <span>Main Carrier Volume</span>
          <strong id="mainCarrierVol">0 ml</strong>
        </div>
        <div class="result carrier">
          <span>Main Carrier Weight</span>
          <strong id="mainCarrierWeight">0 g</strong>
        </div>

        <div class="result carrier hidden" id="secondCarrierVolResult">
          <span>Second Carrier Volume</span>
          <strong id="secondCarrierVol">0 ml</strong>
        </div>
        <div class="result carrier hidden" id="secondCarrierWeightResult">
          <span>Second Carrier Weight</span>
          <strong id="secondCarrierWeight">0 g</strong>
        </div>

        <!-- Right: Info -->
        <div class="result">
          <span>Total Compound Volume</span>
          <strong id="compoundVol">0 ml</strong>
        </div>
        <div class="result">
          <span>Total Brew Volume</span>
          <strong id="totalBrew">0 ml</strong>
        </div>
        <div class="result">
          <span>Volume Check</span>
          <strong id="checkVol">0 ml</strong>
        </div>

        <!-- Final Yield -->
        <div class="result final-yield">
          <span>Final Yield</span>
          <strong id="finalYield">0 ml</strong>
        </div>
      </div>

      <div class="chart-container">
        <canvas id="pieChart"></canvas>
      </div>
    </div>
  </div>

  <div class="actions">
    <button onclick="downloadPDF()">Download as PDF</button>
    <button onclick="downloadDOCX()">Download as DOCX</button>
    <button onclick="goToSingle()">Go to Single Calc</button>
  </div>
</div>

<div class="footer">
  Dinfar Brew ©
</div>

<script>
const displacements = {
  "custom": 0.909,
  "test-base": 0.909,
  "test-p": 0.916,
  "test-phenyl": 0.954,
  "test-c": 0.909,
  "test-e": 0.943,
  "test-iso": 0.935,
  "test-deca": 0.962,
  "test-susp": 1.000,
  "test-undecanoate": 0.97,
  "tren-a": 0.848,
  "tren-e": 0.909,
  "tren-hex": 0.909,
  "nandrolone-base": 0.89,
  "deca": 0.962,
  "npp": 0.877,
  "eq": 0.952,
  "bold-cyp": 0.909,
  "masteron-p": 0.935,
  "masteron-e": 0.962,
  "primo-e": 0.952,
  "trestolone": 0.900,
  "trestolone-a": 0.901,
  "dhb": 0.97,
  "winstrol": 0.885,
  "dbol": 0.892,
  "anadrol": 0.86,
  "anavar": 0.9,
  "tbol": 0.83,
  "sdrol": 0.909,
  "proviron": 0.909,
  "yk11": 0.820
};

const densities = {
  ba: 1.044,
  bb: 1.118,
  castor: 0.96,
  gso: 0.92,
  sesame: 0.92,
  mct: 0.95,
  mig840: 0.94,
  mig812: 0.95,
  eo: 0.87,
  'ethyl-lactate': 1.035,
  guaiacol: 1.129,
  peg400: 1.128,
  dmso: 1.10,
  none: 1.0
};

let chart;

function updateDisplacement(num) {
  const select = document.getElementById(`compound${num}`);
  const dispInput = document.getElementById(`disp${num}`);
  const selected = select.value;
  
  if (selected !== "custom") {
    dispInput.value = displacements[selected].toFixed(3);
  }
  calc();
}

function toggleCompound(num) {
  const checked = document.getElementById(`enableCompound${num}`).checked;
  document.getElementById(`compound${num}Group`).classList.toggle('hidden', !checked);
  document.getElementById(`powder${num}Result`).classList.toggle('hidden', !checked);
  if (!checked) {
    document.getElementById(`mgml${num}`).value = 0;
  }
  calc();
}

function toggleExtraSolvent() {
  const checked = document.getElementById('enableExtraSolvent').checked;
  document.getElementById('extraSolventGroup').classList.toggle('hidden', !checked);
  document.getElementById('extraSolventVolResult').classList.toggle('hidden', !checked);
  document.getElementById('extraSolventWeightResult').classList.toggle('hidden', !checked);
  if (!checked) {
    document.getElementById('extraSolventPct').value = 0;
    document.getElementById('extraSolventType').value = 'none';
  }
  calc();
}

function toggleSecondCarrier() {
  const checked = document.getElementById('enableSecondCarrier').checked;
  document.getElementById('secondCarrierGroup').classList.toggle('hidden', !checked);
  document.getElementById('secondCarrierVolResult').classList.toggle('hidden', !checked);
  document.getElementById('secondCarrierWeightResult').classList.toggle('hidden', !checked);
  if (!checked) {
    document.getElementById('carrierMixPct').value = 0;
    document.getElementById('secondCarrier').value = 'none';
  }
  calc();
}

function showCustomFields() {
  document.getElementById('customLossField').style.display = document.getElementById('filter').value === 'custom' ? 'block' : 'none';
  document.getElementById('customExtraSolventDensityField').style.display = (document.getElementById('extraSolventType').value === 'custom' && document.getElementById('enableExtraSolvent').checked) ? 'block' : 'none';
  document.getElementById('customMainCarrierField').style.display = document.getElementById('mainCarrier').value === 'custom' ? 'block' : 'none';
  document.getElementById('customSecondCarrierField').style.display = (document.getElementById('secondCarrier').value === 'custom' && document.getElementById('enableSecondCarrier').checked) ? 'block' : 'none';
}

function calc() {
  showCustomFields();

  const desiredVol = parseFloat(document.getElementById('totalVol').value) || 0;

  const filterType = document.getElementById('filter').value;
  let filterLoss = 0;
  if (filterType === '0.45') filterLoss = 1.0;
  else if (filterType === '0.22') filterLoss = 1.6;
  else if (filterType === 'double') filterLoss = 2.5;
  else if (filterType === 'custom') filterLoss = parseFloat(document.getElementById('customLoss').value) || 0;

  const totalBrewVol = desiredVol + filterLoss;

  // Compounds
  const enable2 = document.getElementById('enableCompound2').checked;
  const enable3 = document.getElementById('enableCompound3').checked;

  const conc1 = parseFloat(document.getElementById('mgml1').value) || 0;
  const disp1 = parseFloat(document.getElementById('disp1').value) || 0;
  const purity1 = parseFloat(document.getElementById('purity1').value) || 100;

  const conc2 = enable2 ? parseFloat(document.getElementById('mgml2').value) || 0 : 0;
  const disp2 = enable2 ? parseFloat(document.getElementById('disp2').value) || 0 : 0;
  const purity2 = enable2 ? parseFloat(document.getElementById('purity2').value) || 100 : 100;

  const conc3 = enable3 ? parseFloat(document.getElementById('mgml3').value) || 0 : 0;
  const disp3 = enable3 ? parseFloat(document.getElementById('disp3').value) || 0 : 0;
  const purity3 = enable3 ? parseFloat(document.getElementById('purity3').value) || 100 : 100;

  let powder1 = (totalBrewVol * conc1 / 1000) / (purity1 / 100);
  powder1 = conc1 > 0 ? powder1 : 0;

  let powder2 = (totalBrewVol * conc2 / 1000) / (purity2 / 100);
  powder2 = conc2 > 0 ? powder2 : 0;

  let powder3 = (totalBrewVol * conc3 / 1000) / (purity3 / 100);
  powder3 = conc3 > 0 ? powder3 : 0;

  const compoundVol1 = powder1 * disp1;
  const compoundVol2 = powder2 * disp2;
  const compoundVol3 = powder3 * disp3;
  const totalCompoundVol = compoundVol1 + compoundVol2 + compoundVol3;

  // Solvents
  const baPct = parseFloat(document.getElementById('baPct').value) || 0;
  const bbPct = parseFloat(document.getElementById('bbPct').value) || 0;
  const extraSolventPct = document.getElementById('enableExtraSolvent').checked ? parseFloat(document.getElementById('extraSolventPct').value) || 0 : 0;

  const baVol = totalBrewVol * (baPct / 100);
  const bbVol = totalBrewVol * (bbPct / 100);
  const extraSolventVol = totalBrewVol * (extraSolventPct / 100);

  const remainingVol = totalBrewVol - totalCompoundVol - baVol - bbVol - extraSolventVol;

  // Carrier mix
  const carrierMixPct = document.getElementById('enableSecondCarrier').checked ? parseFloat(document.getElementById('carrierMixPct').value) || 0 : 0;

  const mainCarrierRatio = (100 - carrierMixPct) / 100;
  const secondCarrierRatio = carrierMixPct / 100;

  const mainCarrierVol = remainingVol * mainCarrierRatio;
  const secondCarrierVol = remainingVol * secondCarrierRatio;

  // Densities
  let mainCarrierDensity = densities[document.getElementById('mainCarrier').value] || 0.92;
  if (document.getElementById('mainCarrier').value === 'custom') mainCarrierDensity = parseFloat(document.getElementById('customMainCarrierDensity').value) || 0.92;

  let secondCarrierDensity = densities[document.getElementById('secondCarrier').value] || 0.92;
  if (document.getElementById('secondCarrier').value === 'custom') secondCarrierDensity = parseFloat(document.getElementById('customSecondCarrierDensity').value) || 0.92;

  let extraSolventDensity = densities[document.getElementById('extraSolventType').value] || 1.0;
  if (document.getElementById('extraSolventType').value === 'custom') extraSolventDensity = parseFloat(document.getElementById('customExtraSolventDensity').value) || 1.0;

  // Weights
  const baWeight = baVol * densities.ba;
  const bbWeight = bbVol * densities.bb;
  const extraSolventWeight = extraSolventVol * extraSolventDensity;
  const mainCarrierWeight = mainCarrierVol * mainCarrierDensity;
  const secondCarrierWeight = secondCarrierVol * secondCarrierDensity;

  const check = totalCompoundVol + baVol + bbVol + extraSolventVol + mainCarrierVol + secondCarrierVol;

  // Update UI
  document.getElementById('powder1').textContent = powder1.toFixed(3) + ' g';
  document.getElementById('powder2').textContent = powder2.toFixed(3) + ' g';
  document.getElementById('powder3').textContent = powder3.toFixed(3) + ' g';
  document.getElementById('compoundVol').textContent = totalCompoundVol.toFixed(3) + ' ml';
  document.getElementById('baVol').textContent = baVol.toFixed(2) + ' ml';
  document.getElementById('baWeight').textContent = baWeight.toFixed(3) + ' g';
  document.getElementById('bbVol').textContent = bbVol.toFixed(2) + ' ml';
  document.getElementById('bbWeight').textContent = bbWeight.toFixed(3) + ' g';
  document.getElementById('extraSolventVol').textContent = extraSolventVol.toFixed(2) + ' ml';
  document.getElementById('extraSolventWeight').textContent = extraSolventWeight.toFixed(3) + ' g';
  document.getElementById('mainCarrierVol').textContent = mainCarrierVol.toFixed(2) + ' ml';
  document.getElementById('mainCarrierWeight').textContent = mainCarrierWeight.toFixed(3) + ' g';
  document.getElementById('secondCarrierVol').textContent = secondCarrierVol.toFixed(2) + ' ml';
  document.getElementById('secondCarrierWeight').textContent = secondCarrierWeight.toFixed(3) + ' g';
  document.getElementById('totalBrew').textContent = totalBrewVol.toFixed(2) + ' ml';
  document.getElementById('finalYield').textContent = desiredVol.toFixed(2) + ' ml';
  document.getElementById('checkVol').textContent = check.toFixed(2) + ' ml';

  // Chart
  const ctx = document.getElementById('pieChart').getContext('2d');
  const carrierTotal = mainCarrierVol + secondCarrierVol;
  const data = [totalCompoundVol, baVol, bbVol, extraSolventVol > 0.01 ? extraSolventVol : 0, carrierTotal];
  const labels = ['Compound Displacement', 'BA', 'BB', extraSolventVol > 0.01 ? 'Extra Solvent' : null, 'Carrier Oil'].filter(Boolean);
  const colors = ['#c41e3a', '#e91e63', '#ff9800', extraSolventVol > 0.01 ? '#ffeb3b' : null, '#4caf50'].filter(Boolean);

  const filteredData = data.filter(val => val > 0.01);
  const filteredLabels = labels.filter((_, i) => data[i] > 0.01);
  const filteredColors = colors.filter((_, i) => data[i] > 0.01);

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: filteredLabels,
      datasets: [{
        data: filteredData,
        backgroundColor: filteredColors,
        borderColor: '#111',
        borderWidth: 3,
        hoverBorderWidth: 5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: { position: 'bottom', labels: { color: '#fff', font: { size: 15 }, padding: 20, usePointStyle: true } },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.parsed;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((value / total) * 100).toFixed(1);
              return `${context.label}: ${value.toFixed(3)} ml (${percentage}%)`;
            }
          }
        }
      }
    }
  });
}

updateDisplacement(1);
calc();
</script>

</body>
</html>
